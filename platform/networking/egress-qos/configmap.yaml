apiVersion: v1
kind: ConfigMap
metadata:
  name: egress-qos-config
  namespace: kube-system
data:
  setup.sh: |
    #!/bin/sh
    set -euo pipefail

    : "${WAN_IFACE:=enp195s0}"
    : "${LINK_CEIL:=1000mbit}"
    : "${BULK_RATE:=500mbit}"
    : "${BULK_CEIL:=${LINK_CEIL}}"
    : "${SYNC_INTERVAL:=5}"
    : "${LABEL_SELECTOR:=traffic-tier=bulk-seed}"
    : "${IPSET_NAME:=bulkseed-pods}"
    : "${FW_MARK:=1}"

    install_tools() {
      need_tc=false
      need_iptables=false
      need_ipset=false
      need_jq=false

      command -v tc >/dev/null 2>&1      || need_tc=true
      command -v iptables >/dev/null 2>&1 || need_iptables=true
      command -v ipset >/dev/null 2>&1   || need_ipset=true
      command -v jq >/dev/null 2>&1      || need_jq=true

      if [ "$need_tc" = true ] || [ "$need_iptables" = true ] || [ "$need_ipset" = true ] || [ "$need_jq" = true ]; then
        if command -v apk >/dev/null 2>&1; then
          apk add --no-cache \
            $( [ "$need_tc" = true ] && echo iproute2 ) \
            $( [ "$need_iptables" = true ] && echo iptables ) \
            $( [ "$need_ipset" = true ] && echo ipset ) \
            $( [ "$need_jq" = true ] && echo jq ) >/dev/null
        elif command -v apt-get >/dev/null 2>&1; then
          apt-get update >/dev/null
          apt-get install -y --no-install-recommends \
            $( [ "$need_tc" = true ] && echo iproute2 ) \
            $( [ "$need_iptables" = true ] && echo iptables ) \
            $( [ "$need_ipset" = true ] && echo ipset ) \
            $( [ "$need_jq" = true ] && echo jq ) >/dev/null
        else
          echo "No supported package manager found to install tc/iptables/ipset/jq" >&2
          exit 1
        fi
      fi

      if ! command -v kubectl >/dev/null 2>&1; then
        echo "kubectl not found; this container needs kubectl to query pods" >&2
        exit 1
      fi
    }

    ensure_ipset() {
      ipset list "${IPSET_NAME}" >/dev/null 2>&1 || ipset create "${IPSET_NAME}" hash:ip family inet
    }

    refresh_ipset() {
      TMP="$(mktemp)"
      kubectl get pods --all-namespaces -l "${LABEL_SELECTOR}" -o json \
        | jq -r '.items[].status.podIP' \
        | grep -E '^[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+$' > "$TMP" || true

      ipset flush "${IPSET_NAME}"
      while IFS= read -r ip; do
        [ -n "$ip" ] && ipset add "${IPSET_NAME}" "$ip" -exist
      done < "$TMP"
      rm -f "$TMP"
    }

    ensure_fwmark_rule() {
      if ! iptables -t mangle -C PREROUTING -m set --match-set "${IPSET_NAME}" src -j MARK --set-mark "${FW_MARK}" >/dev/null 2>&1; then
        iptables -t mangle -A PREROUTING -m set --match-set "${IPSET_NAME}" src -j MARK --set-mark "${FW_MARK}"
      fi
    }

    configure_tc() {
      tc qdisc replace dev "${WAN_IFACE}" root handle 1: htb default 10

      tc class replace dev "${WAN_IFACE}" parent 1: classid 1:1 htb rate "${LINK_CEIL}" ceil "${LINK_CEIL}"
      tc class replace dev "${WAN_IFACE}" parent 1:1 classid 1:10 htb rate "${LINK_CEIL}" ceil "${LINK_CEIL}"
      tc class replace dev "${WAN_IFACE}" parent 1:1 classid 1:20 htb rate "${BULK_RATE}" ceil "${BULK_CEIL}"

      tc qdisc replace dev "${WAN_IFACE}" parent 1:10 handle 10: fq_codel
      tc qdisc replace dev "${WAN_IFACE}" parent 1:20 handle 20: fq_codel

      tc filter replace dev "${WAN_IFACE}" parent 1: protocol ip handle "${FW_MARK}" fw flowid 1:20
    }

    install_tools
    ensure_ipset
    configure_tc
    ensure_fwmark_rule

    echo "egress-qos: shaping ${WAN_IFACE}, default class=link, bulk=${BULK_RATE} ceil ${BULK_CEIL}, label selector ${LABEL_SELECTOR}"

    while true; do
      refresh_ipset
      sleep "${SYNC_INTERVAL}"
    done
